# アーキテクチャ

## システム構成

```
┌─────────────────────────────────────────┐
│           Main (エントリーポイント)        │
│  - ブラウザサポート確認                    │
│  - 初期化制御                             │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐  ┌──────────────┐
│    Css      │  │   Observer   │
│  CSS解析    │  │  状態監視     │
│  スタイル適用│  │  更新処理     │
└──────┬──────┘  └──────┬───────┘
       │                │
       └────────┬───────┘
                ▼
         ┌─────────────┐
         │    Util     │
         │ 共通機能     │
         └─────────────┘
```

## 処理フロー

### 1. 初期化フェーズ

```
1. ページ読み込み
   ↓
2. Main.constructor()
   - ブラウザサポート確認
   ↓
3. Main.init()
   ↓
4. Css.init()
   - <style>タグからCSS取得
   - <link>タグからCSS取得
   - @import解決
   - target疑似クラス抽出
   - スタイルシート生成
   - 属性設定
   ↓
5. Observer.init()
   - イベントリスナー設定
   - 初期状態更新
```

### 2. 実行時フェーズ

```
スクロール or ハッシュ変更
   ↓
Observer.update()
   ↓
各要素の位置計算
   ↓
属性値更新 (current/before/after)
   ↓
CSSスタイル自動適用
```

## データフロー

### CSS解析

```
HTML
  ├─ <style>タグ
  │   └─ CSS文字列
  └─ <link>タグ
      └─ 外部CSSファイル
          └─ @import解決
              ↓
        統合CSS文字列
              ↓
        コメント削除
              ↓
        正規表現マッチング
              ↓
    {
      current: [{selector, style}, ...],
      before:  [{selector, style}, ...],
      after:   [{selector, style}, ...]
    }
              ↓
        スタイルシート挿入
```

### 状態管理

```
対象要素リスト
[
  {
    link_target: <a>要素,
    pos_target: ターゲット要素,
    hash: "#section1"
  },
  ...
]
    ↓
位置計算（getBoundingClientRect）
    ↓
最小距離の要素を特定
    ↓
属性値設定
  - current: 最も近い要素
  - before: currentより前
  - after: currentより後
```

## モジュール設計

### 責任分離

- **Main**: 初期化制御とブラウザ判定
- **Css**: CSS解析とスタイル生成
- **Observer**: DOM監視と状態更新
- **Util**: 共通ユーティリティ

### 継承関係

```
Util (基底クラス)
  ├─ Main
  ├─ Css
  └─ Observer
```

すべてのクラスが `Util` を継承し、共通機能にアクセスできます。

## パフォーマンス考慮事項

1. **ブラウザサポート確認**: 対応ブラウザでは処理をスキップ
2. **同一ドメイン制限**: 外部CSSは処理対象外
3. **イベント最適化**: スクロールイベントは直接バインド（throttle/debounceは未実装）
4. **CSS挿入**: 動的にスタイルシートを生成し、ブラウザのレンダリングエンジンに委譲

## セキュリティ考慮事項

- 同一ドメインのCSSファイルのみを処理
- `fetch()` APIを使用したファイル読み込み
- XSS対策として外部ドメインのCSSは除外
